<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‰¾æ¢ç´¢-ä¸‰å¤©æå…‰é¢„æŠ¥</title>
  <meta name="description" content="ä¸‰å¤©æå…‰é¢„æŠ¥">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            aurora: {
              blue: '#4096ff',
              green: '#52c41a',
              orange: '#fa8c16',
              red: '#f5222d',
              purple: '#722ed1',
              pink: '#ff4d4f',
              dark: '#141414'
            }
          }
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.8);
      }
      .text-shadow-heavy {
        text-shadow: 0 1px 3px rgba(0,0,0,0.9), 0 0 2px rgba(0,0,0,0.7);
      }
      .glass-effect {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      .live-pulse {
        animation: pulse 4s infinite;
      }
      .current-period {
        animation: highlight 2s infinite alternate;
        background: rgba(255, 77, 79, 0.3) !important;
        border-left: 4px solid #ff4d4f;
      }
      .warning-tooltip {
        animation: pulse 2s infinite;
      }
     
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
      }
      @keyframes highlight {
        0% { background-color: rgba(255, 77, 79, 0.3); }
        100% { background-color: rgba(255, 77, 79, 0.4); }
      }
      
      /* æ°´å°æ ·å¼ */
      .watermark {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .watermark-text {
        font-size: 120px;
        font-weight: bold;
        color: rgba(255, 255, 255, 0.03);
        transform: rotate(-30deg);
        user-select: none;
        white-space: nowrap;
        font-family: 'Microsoft YaHei', sans-serif;
      }
      
      /* æç¤ºæ¡†æ ·å¼ - æ‰‹æœºé€‚é… */
      .tooltip {
        position: relative;
        cursor: pointer;
      }
      
      .tooltip-text {
        visibility: hidden;
        width: 200px;
        background-color: rgba(0, 0, 0, 0.95);
        color: white;
        text-align: left;
        border-radius: 6px;
        padding: 8px 12px;
        position: absolute;
        z-index: 10000;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
        line-height: 1.5;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        margin-bottom: 8px;
      }
      
      .tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }
      
      /* ç™½å¤©/å¤œé—´æ—¶æ®µæ ·å¼ */
      .daytime {
        opacity: 0.6;
      }
      .daytime-label {
        color: #ffd700;
      }
      .nighttime-label {
        color: #4fc3f7;
      }
      
      /* è¡¨æ ¼æ ·å¼ - ç¾åŒ– */
      .time-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
      }
      
      .time-table th {
        text-align: left;
        padding: 8px 6px;
        color: rgba(255, 255, 255, 0.9);
        font-size: 13px;
        font-weight: 600;
        border-bottom: 2px solid rgba(255, 255, 255, 0.2);
      }
      
      .time-table td {
        padding: 10px 6px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        transition: all 0.3s ease;
      }
      
      .time-slot {
        transition: all 0.3s ease;
      }
      
      .time-slot:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-1px);
      }
      
      /* KPæŸ±çŠ¶å›¾æ ·å¼ */
      .kp-bar-container {
        width: 100%;
        height: 28px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 14px;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        min-width: 120px;
      }
      
      .kp-bar {
        height: 100%;
        border-radius: 14px;
        transition: all 0.8s ease;
        position: relative;
        overflow: hidden;
        min-width: 30px; /* ç¡®ä¿å°æ•°å€¼ä¹Ÿæœ‰è¶³å¤Ÿå®½åº¦ */
      }
      
      .kp-bar::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, 
          transparent 0%, 
          rgba(255,255,255,0.2) 50%, 
          transparent 100%);
        animation: shimmer 2s infinite;
      }
      
      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }
      
      .kp-value-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-weight: bold;
        font-size: 12px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        z-index: 2;
        white-space: nowrap;
        padding: 0 8px;
      }
      
      /* KPå€¼é¢œè‰²æ ·å¼ */
      .kp-bar-0-3 { background: linear-gradient(90deg, #52c41a, #73d13d); }
      .kp-bar-4-5 { background: linear-gradient(90deg, #fa8c16, #ffa940); }
      .kp-bar-6 { background: linear-gradient(90deg, #fa541c, #ff7a45); }
      .kp-bar-7-9 { background: linear-gradient(90deg, #f5222d, #ff4d4f); }
      
      .kp-text-low { color: #52c41a; }
      .kp-text-medium { color: #fa8c16; }
      .kp-text-high { color: #f5222d; }
      
      /* è‚‰çœ¼å¯è§æ ‡ç­¾æ ·å¼ */
      .naked-eye {
        display: inline-block;
        background: linear-gradient(45deg, #ffd700, #ffa500);
        color: #000;
        font-size: 10px;
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 6px;
        animation: glow 2s infinite alternate;
      }
      
      @keyframes glow {
        0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.8); }
      }
      
      /* æ¦‚è§ˆå¡ç‰‡ç‚¹å‡»æ•ˆæœ */
      .daily-card {
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .daily-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      }
      
      /* æ‰‹æœºé€‚é…æ ·å¼ */
      @media (max-width: 640px) {
        .watermark-text {
          font-size: 80px;
        }
        
        .tooltip-text {
          width: 180px;
          font-size: 11px;
        }
        
        .time-table th,
        .time-table td {
          padding: 8px 4px;
          font-size: 12px;
        }
        
        /* è°ƒæ•´åˆ—å®½æ¯”ä¾‹ï¼Œç»™KPæŸ±çŠ¶å›¾æ›´å¤šç©ºé—´ */
        .time-table th:nth-child(1),
        .time-table td:nth-child(1) {
          width: 32%;
          padding-left: 8px;
        }
        
        .time-table th:nth-child(2),
        .time-table td:nth-child(2) {
          width: 8%;
          text-align: center;
          padding: 0;
        }
        
        .time-table th:nth-child(3),
        .time-table td:nth-child(3) {
          width: 60%;
          padding-right: 8px;
        }
        
        .kp-bar-container {
          height: 24px;
          min-width: 100px;
        }
        
        .kp-value-text {
          font-size: 11px;
          padding: 0 6px;
        }
        
        /* æ—¥æœŸæ—¶é—´ç´§å‡‘æ˜¾ç¤º */
        .compact-date {
          font-size: 12px;
          line-height: 1.2;
        }
        
        .compact-time {
          font-size: 11px;
          line-height: 1.2;
        }
      }
      
      /* æ¡Œé¢ç«¯æ ·å¼ */
      @media (min-width: 641px) {
        .time-table th:nth-child(1),
        .time-table td:nth-child(1) {
          width: 35%;
          padding-left: 12px;
        }
        
        .time-table th:nth-child(2),
        .time-table td:nth-child(2) {
          width: 10%;
          text-align: center;
          padding: 0;
        }
        
        .time-table th:nth-child(3),
        .time-table td:nth-child(3) {
          width: 55%;
          padding-right: 12px;
        }
      }
    }
  </style>
</head>
<body class="bg-transparent overflow-x-hidden">
  <!-- æ°´å° -->
  <div class="watermark">
    <div class="watermark-text">è‰¾æ¢ç´¢</div>
  </div>

  <div class="min-h-screen bg-gradient-to-br from-gray-900 to-blue-900 p-4 relative z-10">
    <!-- é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ -->
    <div class="glass-effect rounded-2xl p-4 mb-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="w-10 h-10 md:w-12 md:h-12 bg-gradient-to-r from-aurora-blue to-aurora-purple rounded-full flex items-center justify-center mr-3">
            <i class="fa fa-star text-white text-sm md:text-lg"></i>
          </div>
          <div>
            <div class="text-white font-bold text-shadow text-lg md:text-xl">è‰¾æ¢ç´¢-ä¸‰å¤©æå…‰é¢„æŠ¥</div>
            <div id="datetime" class="text-white text-xs md:text-sm text-shadow-heavy">2025/10/15 14:30:00</div>
          </div>
        </div>
        
        <!-- åˆ é™¤å³ä¸Šè§’æç¤ºå’Œæœ€å¤§KP -->
        <div class="flex items-center space-x-2 md:space-x-3">
          <div class="text-aurora-green text-xs md:text-sm">
            è‡ªåŠ¨æ›´æ–°: <span id="refresh-timer">5:00</span>
          </div>
        </div>
      </div>
    </div>

    <!-- æœªæ¥ä¸‰å¤©æœ€å¤§KPå€¼æ¦‚è§ˆ -->
    <div class="glass-effect rounded-2xl p-4 mb-4">
      <div class="text-white text-base font-bold text-shadow-heavy text-center mb-3">
        æœªæ¥ä¸‰å¤©æå…‰æ´»åŠ¨æ¦‚è§ˆ
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3" id="daily-max-overview">
        <!-- å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>

    <!-- é¢„æŠ¥è¯´æ˜ -->
    <div class="glass-effect rounded-xl p-3 mb-4">
      <div class="text-white text-base font-bold text-shadow-heavy text-center">
        æœªæ¥ä¸‰å¤©æå…‰æ´»åŠ¨ï¼ˆæŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼‰
      </div>
      <div class="text-center text-aurora-green text-xs mt-1">
        <i class="fa fa-moon mr-1"></i>è“è‰²=å¤œé—´ï¼ˆå¯è§‚æµ‹ï¼‰ 
        <i class="fa fa-sun ml-3 mr-1"></i>é»„è‰²=ç™½å¤©ï¼ˆä¸å¯è§‚æµ‹ï¼‰
        <span class="ml-3 text-aurora-red"><i class="fa fa-circle text-xs"></i> å½“å‰æ—¶æ®µ</span>
        <span class="ml-3 text-aurora-orange"><i class="fa fa-exclamation-triangle text-xs"></i> é«˜æ´»æ€§æç¤º</span>
      </div>
    </div>

    <!-- ç»Ÿä¸€æ—¶æ®µè¡¨æ ¼ï¼ˆæ— æ—¥æœŸåˆ†ç»„ï¼ŒæŒ‰æ—¶é—´æ’åºï¼‰ -->
    <div class="glass-effect rounded-2xl p-4 mb-4">
      <div class="overflow-x-auto">
        <table class="time-table w-full" id="all-periods-table">
          <thead>
            <tr>
              <th>åŒ—äº¬æ—¶é—´</th>
              <th></th> <!-- æç¤ºå›¾æ ‡åˆ— -->
              <th>KPå€¼å¼ºåº¦</th>
            </tr>
          </thead>
          <tbody>
            <!-- æ—¶æ®µæ•°æ®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆï¼ŒæŒ‰æ—¶é—´é¡ºåºæ’åˆ— -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- æ•°æ®æºå’Œåˆ·æ–° - åˆ é™¤åˆ·æ–°æŒ‰é’® -->
    <div class="glass-effect rounded-2xl p-4 mb-4">
      <div class="text-center text-gray-300 text-xs">
        æ•°æ®æ¥æº: NOAA ç¾å›½å›½å®¶æµ·æ´‹å’Œå¤§æ°”ç®¡ç†å±€ | è‡ªåŠ¨æ›´æ–°å‘¨æœŸï¼š5åˆ†é’Ÿ
      </div>
    </div>

    <!-- åº•éƒ¨ä¿¡æ¯ -->
    <div class="text-center text-gray-400 text-xs mt-4 pb-4">
      <div>å…¬ä¼—å·:æå…‰é¢„æŠ¥-å°çº¢ä¹¦ï¼šè‰¾æ¢ç´¢è¿½æå…‰ Â© 2025</div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡ï¼šå­˜å‚¨æ‰€æœ‰æ—¶æ®µæ•°æ®
    let allPeriodsData = [];
    let refreshTimer = 300; // 5åˆ†é’Ÿå€’è®¡æ—¶

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // å®æ—¶æ›´æ–°æ—¶é—´
      updateTime();
      setInterval(updateTime, 1000);
      
      // å¯åŠ¨5åˆ†é’Ÿå€’è®¡æ—¶
      startRefreshTimer();
      
      // åŠ è½½é¢„æŠ¥æ•°æ®
      fetchForecast();
      
      // æ¯5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
      setInterval(fetchForecast, 300000);
    });

    // 5åˆ†é’Ÿå€’è®¡æ—¶
    function startRefreshTimer() {
      setInterval(() => {
        refreshTimer--;
        if (refreshTimer <= 0) {
          refreshTimer = 300; // é‡ç½®ä¸º5åˆ†é’Ÿ
        }
        
        const minutes = Math.floor(refreshTimer / 60);
        const seconds = refreshTimer % 60;
        document.getElementById('refresh-timer').textContent = 
          `${minutes}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    // æ›´æ–°å½“å‰æ—¶é—´
    function updateTime() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      
      document.getElementById('datetime').innerHTML = `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
      
      // å®æ—¶æ›´æ–°å½“å‰æ—¶æ®µé«˜äº®
      highlightCurrentPeriod();
    }

    // ä»NOAAè·å–æ•°æ®
    async function fetchForecast() {
      try {
        const response = await fetch('https://services.swpc.noaa.gov/text/3-day-forecast.txt');
        if (!response.ok) throw new Error(`çŠ¶æ€ç : ${response.status}`);
        
        const data = await response.text();
        allPeriodsData = processForecastData(data); // å¤„ç†ä¸ºç»Ÿä¸€æ—¶æ®µæ•°ç»„
        renderAllPeriodsTable(); // æ¸²æŸ“è¡¨æ ¼ï¼ˆæŒ‰æ—¶é—´æ’åºï¼‰
        renderDailyMaxOverview(); // æ¸²æŸ“æ¯æ—¥æœ€å¤§KPæ¦‚è§ˆ
        
        // é‡ç½®å€’è®¡æ—¶
        refreshTimer = 300;
        
      } catch (error) {
        console.error('æ•°æ®è·å–å¤±è´¥:', error);
        renderErrorState(); // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        // 30ç§’åé‡è¯•
        setTimeout(fetchForecast, 30000);
      }
    }

    // å¤„ç†NOAAæ•°æ®ï¼šè½¬æ¢ä¸ºç»Ÿä¸€æ—¶æ®µæ•°ç»„ï¼ˆæ— æ—¥æœŸåˆ†ç»„ï¼‰
    function processForecastData(rawData) {
      const periods = [];
      const lines = rawData.split('\n');
      let inTable = false;
      
      // æå–UTCæ—¥æœŸæ ‡é¢˜
      const dateTitles = [];
      for (const line of lines) {
        // æŸ¥æ‰¾åŒ…å«æ—¥æœŸæ ‡é¢˜çš„è¡Œï¼Œä¾‹å¦‚ "Oct 15       Oct 16       Oct 17"
        if (line.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2}/g)) {
          const matches = line.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{1,2}/g);
          if (matches && matches.length >= 3) {
            dateTitles.push(...matches);
            break;
          }
        }
      }
      
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ—¥æœŸæ ‡é¢˜ï¼Œä½¿ç”¨é»˜è®¤æ—¥æœŸ
      if (dateTitles.length === 0) {
        const today = new Date();
        for (let i = 0; i < 3; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() + i);
          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          dateTitles.push(`${monthNames[date.getMonth()]} ${date.getDate()}`);
        }
      }

      // è§£æNOAAæ–‡æœ¬è¡¨æ ¼
      for (const line of lines) {
        const trimLine = line.trim();
        
        // è¯†åˆ«è¡¨æ ¼å¼€å§‹ï¼ˆåŒ…å«æ—¶æ®µæ ‡è¯†ï¼‰
        if (trimLine.includes('00-03UT') || trimLine.includes('03-06UT')) inTable = true;
        if (!inTable || !trimLine) continue;
        
        // åŒ¹é…æ—¶æ®µå’ŒKPå€¼ï¼ˆæ ¼å¼ï¼šæ—¶æ®µ ç¬¬ä¸€å¤©KP ç¬¬äºŒå¤©KP ç¬¬ä¸‰å¤©KPï¼‰
        const match = trimLine.match(/(\d{2}-\d{2}UT)\s+([\d.]+)(?:\s*\(G\d\))?\s+([\d.]+)(?:\s*\(G\d\))?\s+([\d.]+)(?:\s*\(G\d\))?/);
        if (!match) continue;

        const [_, utcTime, day1Kp, day2Kp, day3Kp] = match;
        // å¤„ç†3å¤©çš„æ—¶æ®µæ•°æ®ï¼ˆdayOffsetï¼š0=ç¬¬ä¸€å¤©ï¼Œ1=ç¬¬äºŒå¤©ï¼Œ2=ç¬¬ä¸‰å¤©ï¼‰
        [0, 1, 2].forEach(dayOffset => {
          const { beijingDate, beijingTime } = convertUtcToBeijing(utcTime, dayOffset, dateTitles);
          const kp = parseFloat([day1Kp, day2Kp, day3Kp][dayOffset]);
          const periodType = getPeriodType(beijingTime); // ç™½å¤©/å¤œé—´
          const timestamp = getPeriodTimestamp(beijingDate, beijingTime); // æ—¶é—´æˆ³ï¼ˆç”¨äºæ’åºï¼‰
          const [periodStart, periodEnd] = getPeriodTimeRange(beijingDate, beijingTime); // æ—¶æ®µèµ·æ­¢æ—¶é—´æˆ³

          periods.push({
            beijingDate: beijingDate, // åŒ—äº¬æ—¥æœŸï¼ˆå¦‚"10æœˆ15æ—¥"ï¼‰
            beijingTime: beijingTime, // åŒ—äº¬æ—¶é—´æ®µï¼ˆå¦‚"08-11æ—¶"ï¼‰
            kp: kp,
            periodType: periodType, // "day"æˆ–"night"
            timestamp: timestamp, // æ—¶æ®µå¼€å§‹æ—¶é—´æˆ³
            periodStart: periodStart, // æ—¶æ®µå¼€å§‹æ—¶é—´æˆ³ï¼ˆç”¨äºåˆ¤æ–­å½“å‰æ—¶æ®µï¼‰
            periodEnd: periodEnd, // æ—¶æ®µç»“æŸæ—¶é—´æˆ³
            isHighActivity: kp >= 5, // æ˜¯å¦é«˜æ´»æ€§ï¼ˆKPâ‰¥5ï¼Œæ˜¾ç¤ºæç¤ºï¼‰
            nakedEyeVisible: kp >= 7 && periodType === 'night' // æ˜¯å¦è‚‰çœ¼å¯è§ï¼ˆKPâ‰¥7ä¸”å¤œé—´ï¼‰
          });
        });
      }

      // æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆä»æ—©åˆ°æ™šï¼‰
      return periods.sort((a, b) => a.timestamp - b.timestamp);
    }

    // UTCæ—¶é—´è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
    function convertUtcToBeijing(utcTime, dayOffset, dateTitles) {
      const [utcStart, utcEnd] = utcTime.replace('UT', '').split('-').map(Number);
      
      // è·å–UTCæ—¥æœŸ
      const utcDateStr = dateTitles[dayOffset];
      
      // è§£æUTCæ—¥æœŸ
      const [monthStr, day] = utcDateStr.split(' ');
      const monthMap = {
        'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
        'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
      };
      
      const year = new Date().getFullYear();
      const month = monthMap[monthStr];
      const utcDay = parseInt(day);
      
      // è®¡ç®—åŒ—äº¬æ—¶é—´çš„å¼€å§‹å’Œç»“æŸå°æ—¶
      let bjStartHour = (utcStart + 8) % 24;
      let bjEndHour = (utcEnd + 8) % 24;
      
      // è®¡ç®—åŒ—äº¬æ—¥æœŸ
      const bjDate = new Date(year, month, utcDay);
      if (utcStart + 8 >= 24) {
        bjDate.setDate(bjDate.getDate() + 1);
      }
      
      // æ ¼å¼åŒ–åŒ—äº¬æ—¥æœŸ
      const bjDateStr = `${bjDate.getMonth() + 1}æœˆ${bjDate.getDate()}æ—¥`;
      // æ ¼å¼åŒ–åŒ—äº¬æ—¶æ®µ
      const bjTimeStr = `${String(bjStartHour).padStart(2, '0')}-${String(bjEndHour).padStart(2, '0')}æ—¶`;

      return { 
        beijingDate: bjDateStr,
        beijingTime: bjTimeStr
      };
    }

    // åˆ¤æ–­æ—¶æ®µç±»å‹ï¼ˆç™½å¤©ï¼š7:00-16:00ï¼Œå¤œé—´ï¼šå…¶ä»–ï¼‰
    function getPeriodType(beijingTime) {
      const startHour = parseInt(beijingTime.split('-')[0]);
      return (startHour >= 7 && startHour < 16) ? 'day' : 'night';
    }

    // è·å–æ—¶æ®µæ—¶é—´æˆ³ï¼ˆç”¨äºæ’åºï¼‰
    function getPeriodTimestamp(beijingDate, beijingTime) {
      const [month, day] = beijingDate.match(/(\d+)æœˆ(\d+)æ—¥/).slice(1).map(Number);
      const startHour = parseInt(beijingTime.split('-')[0]);
      const year = new Date().getFullYear();
      return new Date(year, month - 1, day, startHour).getTime();
    }

    // è·å–æ—¶æ®µèµ·æ­¢æ—¶é—´æˆ³ï¼ˆç”¨äºåˆ¤æ–­å½“å‰æ—¶æ®µï¼‰
    function getPeriodTimeRange(beijingDate, beijingTime) {
      const [month, day] = beijingDate.match(/(\d+)æœˆ(\d+)æ—¥/).slice(1).map(Number);
      const [startHour, endHour] = beijingTime.split('-').map(h => parseInt(h.replace('æ—¶', '')));
      const year = new Date().getFullYear();
      
      const periodStart = new Date(year, month - 1, day, startHour).getTime();
      // å¤„ç†è·¨å¤©æ—¶æ®µï¼ˆå¦‚"21-00æ—¶"â†’ç»“æŸæ—¶é—´ä¸ºæ¬¡æ—¥0ç‚¹ï¼‰
      const periodEnd = endHour < startHour 
        ? new Date(year, month - 1, day + 1, endHour).getTime()
        : new Date(year, month - 1, day, endHour).getTime();

      return [periodStart, periodEnd];
    }

    // è·å–KPæŸ±çŠ¶å›¾é¢œè‰²ç±»
    function getKpBarColorClass(kp) {
      if (kp >= 7) return 'kp-bar-7-9';
      if (kp >= 6) return 'kp-bar-6';
      if (kp >= 4) return 'kp-bar-4-5';
      return 'kp-bar-0-3';
    }

    // è·å–KPå€¼æ–‡æœ¬é¢œè‰²ç±»
    function getKpTextColorClass(kp) {
      if (kp >= 6) return 'kp-text-high';
      if (kp >= 4) return 'kp-text-medium';
      return 'kp-text-low';
    }

    // è·å–KPå€¼è§‚æµ‹å»ºè®®
    function getKpSuggestion(kp) {
      if (kp >= 7) {
        return { text: 'è‚‰çœ¼å¯è§', class: 'kp-text-high' };
      } else if (kp >= 6) {
        return { text: 'éšçº¦å¯è§', class: 'kp-text-high' };
      } else if (kp >= 4) {
        return { text: 'æ‹æ‘„å¯è§', class: 'kp-text-medium' };
      } else {
        return { text: 'å¼±æ´»åŠ¨', class: 'kp-text-low' };
      }
    }

    // æ¸²æŸ“æ¯æ—¥æœ€å¤§KPæ¦‚è§ˆ
    function renderDailyMaxOverview() {
      const overviewContainer = document.getElementById('daily-max-overview');
      overviewContainer.innerHTML = '';
      
      if (allPeriodsData.length === 0) return;
      
      // æŒ‰æ—¥æœŸåˆ†ç»„
      const dailyData = {};
      allPeriodsData.forEach(period => {
        if (!dailyData[period.beijingDate]) {
          dailyData[period.beijingDate] = [];
        }
        dailyData[period.beijingDate].push(period);
      });
      
      // è®¡ç®—æ¯æ—¥æœ€å¤§KPå€¼
      const dailyMax = [];
      Object.keys(dailyData).forEach(date => {
        const maxKp = Math.max(...dailyData[date].map(p => p.kp));
        dailyMax.push({ date, maxKp });
      });
      
      // æ¸²æŸ“æ¯æ—¥æ¦‚è§ˆå¡ç‰‡
      dailyMax.forEach((day, index) => {
        const card = document.createElement('div');
        card.className = 'glass-effect rounded-xl p-3 text-center daily-card';
        card.dataset.date = day.date;
        
        // æ ¹æ®KPå€¼ç¡®å®šè§‚æµ‹å»ºè®®
        const suggestion = getKpSuggestion(day.maxKp);
        
        card.innerHTML = `
          <div class="text-white font-bold text-shadow mb-2">${day.date}</div>
          <div class="text-2xl font-bold text-shadow mb-2 ${suggestion.class}">KP ${day.maxKp.toFixed(1)}</div>
          <div class="text-xs ${suggestion.class}">${suggestion.text}</div>
        `;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        card.addEventListener('click', function() {
          scrollToDatePeriods(day.date);
        });
        
        overviewContainer.appendChild(card);
      });
    }

    // æ»šåŠ¨åˆ°æŒ‡å®šæ—¥æœŸçš„æ—¶æ®µ
    function scrollToDatePeriods(targetDate) {
      const rows = document.querySelectorAll('.time-slot');
      let found = false;
      
      rows.forEach((row, index) => {
        const dateCell = row.querySelector('.compact-date');
        if (dateCell && dateCell.textContent === targetDate) {
          if (!found) {
            // æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ—¥æœŸ
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            found = true;
            
            // æ·»åŠ ä¸´æ—¶é«˜äº®æ•ˆæœ
            row.style.backgroundColor = 'rgba(255, 215, 0, 0.2)';
            setTimeout(() => {
              row.style.backgroundColor = '';
            }, 2000);
          }
        }
      });
      
      if (!found) {
        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œæ»šåŠ¨åˆ°é¡¶éƒ¨
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    // æ¸²æŸ“æ‰€æœ‰æ—¶æ®µè¡¨æ ¼
    function renderAllPeriodsTable() {
      const tableBody = document.querySelector('#all-periods-table tbody');
      tableBody.innerHTML = '';

      if (allPeriodsData.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-400 py-6">æš‚æ— æ—¶æ®µæ•°æ®</td></tr>`;
        return;
      }

      // éå†æ¸²æŸ“æ¯ä¸ªæ—¶æ®µ
      allPeriodsData.forEach(period => {
        const row = document.createElement('tr');
        row.className = `time-slot ${period.periodType === 'day' ? 'daytime' : ''}`;
        // å­˜å‚¨æ—¶æ®µèµ·æ­¢æ—¶é—´ï¼ˆç”¨äºåç»­é«˜äº®ï¼‰
        row.dataset.periodStart = period.periodStart;
        row.dataset.periodEnd = period.periodEnd;

        // 1. åŒ—äº¬æ—¶é—´åˆ— - ç´§å‡‘æ˜¾ç¤º
        const dateTimeCell = document.createElement('td');
        const periodIcon = period.periodType === 'day' ? 'â˜€ï¸' : 'ğŸŒ™';
        dateTimeCell.className = `${period.periodType === 'day' ? 'daytime-label' : 'nighttime-label'}`;
        dateTimeCell.innerHTML = `
          <div class="compact-date font-medium">${period.beijingDate}</div>
          <div class="compact-time text-sm opacity-90">${period.beijingTime} ${periodIcon}</div>
        `;
        row.appendChild(dateTimeCell);

        // 2. æç¤ºå›¾æ ‡åˆ—ï¼ˆé«˜æ´»æ€§æç¤ºï¼‰- å±…ä¸­æ˜¾ç¤º
        const tipCell = document.createElement('td');
        if (period.isHighActivity) {
          tipCell.className = 'tooltip';
          // æç¤ºå›¾æ ‡
          const tipIcon = document.createElement('span');
          tipIcon.className = 'inline-block text-aurora-orange warning-tooltip';
          tipIcon.innerHTML = '<i class="fa fa-exclamation-triangle"></i>';
          
          // æç¤ºå†…å®¹
          const tipText = document.createElement('span');
          tipText.className = 'tooltip-text';
          
          const suggestion = getKpSuggestion(period.kp);
          
          tipText.innerHTML = `
            <strong>é«˜æ´»æ€§æ—¶æ®µï¼ˆKP=${period.kp}ï¼‰</strong><br>
            â€¢ è§‚æµ‹å»ºè®®ï¼š${period.periodType === 'night' ? 
              suggestion.text : 
              'ç™½å¤©ä¸å¯è§'}</br>
            â€¢ å¯è§åŒºåŸŸï¼š${period.kp >= 6 ? 'ä¸­é«˜çº¬åº¦åœ°åŒº' : 'åŒ—æ–¹é«˜çº¬åº¦åœ°åŒº'}<br>
            â€¢ å»ºè®®å‡†å¤‡ï¼šä¸‰è„šæ¶ï¼ˆé•¿æ›å…‰æ‹æ‘„ï¼‰
          `;
          
          tipCell.appendChild(tipIcon);
          tipCell.appendChild(tipText);
        }
        row.appendChild(tipCell);

        // 3. KPå€¼å¼ºåº¦åˆ— - ç»™æŸ±çŠ¶å›¾æ›´å¤šç©ºé—´
        const kpCell = document.createElement('td');
        
        const kpContainer = document.createElement('div');
        kpContainer.className = 'flex flex-col space-y-2';
        
        // KPæŸ±çŠ¶å›¾
        const barContainer = document.createElement('div');
        barContainer.className = 'kp-bar-container';
        
        const kpBar = document.createElement('div');
        kpBar.className = `kp-bar ${getKpBarColorClass(period.kp)}`;
        // KPå€¼èŒƒå›´0-9ï¼ŒåŠ¨æ€è®¡ç®—å®½åº¦ï¼Œç¡®ä¿å°æ•°å€¼ä¹Ÿæœ‰è¶³å¤Ÿæ˜¾ç¤ºç©ºé—´
        const barWidth = Math.max((period.kp / 9) * 100, 15); // æœ€å°15%å®½åº¦
        kpBar.style.width = `${barWidth}%`;
        
        const kpValueText = document.createElement('div');
        kpValueText.className = 'kp-value-text';
        kpValueText.textContent = `KP ${period.kp}`;
        
        kpBar.appendChild(kpValueText);
        barContainer.appendChild(kpBar);
        
        // è§‚æµ‹å»ºè®®
        const suggestion = getKpSuggestion(period.kp);
        const suggestionText = document.createElement('div');
        suggestionText.className = `text-xs text-center ${suggestion.class} font-medium`;
        suggestionText.textContent = suggestion.text;
        
        kpContainer.appendChild(barContainer);
        kpContainer.appendChild(suggestionText);
        
        // åªæœ‰KPâ‰¥7ä¸”å¤œé—´æ‰æ˜¾ç¤ºè‚‰çœ¼å¯è§æ ‡ç­¾
        if (period.nakedEyeVisible) {
          const nakedEyeLabel = document.createElement('div');
          nakedEyeLabel.className = 'text-center';
          const nakedEyeSpan = document.createElement('span');
          nakedEyeSpan.className = 'naked-eye';
          nakedEyeSpan.textContent = 'è‚‰çœ¼å¯è§';
          nakedEyeLabel.appendChild(nakedEyeSpan);
          kpContainer.appendChild(nakedEyeLabel);
        }
        
        kpCell.appendChild(kpContainer);
        row.appendChild(kpCell);

        tableBody.appendChild(row);
      });

      // åˆå§‹é«˜äº®å½“å‰æ—¶æ®µå¹¶æ»šåŠ¨åˆ°è§†å›¾
      highlightCurrentPeriod();
    }

    // é«˜äº®å½“å‰æ—¶æ®µ
    function highlightCurrentPeriod() {
      const now = new Date().getTime();
      const allRows = document.querySelectorAll('.time-slot');
      
      allRows.forEach(row => {
        const periodStart = parseInt(row.dataset.periodStart);
        const periodEnd = parseInt(row.dataset.periodEnd);
        
        if (!isNaN(periodStart) && !isNaN(periodEnd)) {
          row.classList.toggle('current-period', now >= periodStart && now < periodEnd);
        }
      });
    }

    // æ¸²æŸ“é”™è¯¯çŠ¶æ€
    function renderErrorState() {
      const tableBody = document.querySelector('#all-periods-table tbody');
      tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-gray-400 py-6">æ•°æ®è·å–å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•...</td></tr>`;
      
      const overviewContainer = document.getElementById('daily-max-overview');
      overviewContainer.innerHTML = '<div class="col-span-3 text-center text-gray-400 py-4">æ•°æ®è·å–å¤±è´¥</div>';
    }
  </script>
</body>
</html>
