<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AuroraWatch - æå…‰æ•°æ®</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            aurora: {
              blue: '#4096ff',
              green: '#52c41a',
              orange: '#fa8c16',
              red: '#f5222d',
              purple: '#722ed1',
              pink: '#ff4d4f',
              dark: '#141414'
            }
          }
        }
      }
    }
  </script>
  
  <style>
    /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ */
    :root {
      --primary: #4096ff;
      --secondary: #722ed1;
      --dark: #141414;
      --darker: #0a0e14;
      --light: #f1f2f6;
      --card-bg: rgba(255, 255, 255, 0.1);
      --border-color: rgba(255, 255, 255, 0.15);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(to bottom right, #111827, #1e3a8a);
      background-attachment: fixed;
      color: var(--light);
      line-height: 1.6;
      padding: 0;
      min-height: 100vh;
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }
    
    .text-shadow {
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }
    
    .text-shadow-heavy {
      text-shadow: 0 1px 3px rgba(0,0,0,0.9), 0 0 2px rgba(0,0,0,0.7);
    }
    
    .live-pulse {
      animation: pulse 4s infinite;
    }
    
    .warning-pulse {
      animation: warning 4s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }
    
    @keyframes warning {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }
    
    header {
      background: rgba(20, 20, 20, 0.9);
      backdrop-filter: blur(10px);
      padding: 1rem 15px;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 {
      color: var(--primary);
      font-size: 1.4rem;
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }
    
    .current-time {
      color: var(--light);
      font-size: 0.9rem;
      opacity: 0.8;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9), 0 0 2px rgba(0,0,0,0.7);
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 15px;
    }
    
    .dashboard {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 10px;
    }
    
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
      transform: translateY(-2px);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .card-title {
      color: var(--primary);
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9), 0 0 2px rgba(0,0,0,0.7);
    }
    
    .card-icon {
      font-size: 1.2rem;
      opacity: 0.7;
    }
    
    .data-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 15px;
    }
    
    .data-item {
      display: flex;
      flex-direction: column;
      padding: 12px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .data-label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.8rem;
      margin-bottom: 5px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    
    .data-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: white;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9), 0 0 2px rgba(0,0,0,0.7);
    }
    
    .chart-container {
      position: relative;
      height: 200px;
      width: 100%;
      margin-top: 12px;
    }
    
    .alert-card {
      border-left: 4px solid var(--primary);
    }
    
    .alert-card.high-alert {
      border-left-color: #fa8c16;
      animation: warning 2s infinite;
    }
    
    .alert-card.extreme-alert {
      border-left-color: #f5222d;
      animation: warning 1s infinite;
    }
    
    .alert-content {
      font-size: 0.9rem;
      line-height: 1.5;
      padding: 12px;
      background: rgba(64, 150, 255, 0.1);
      border-radius: 8px;
      margin-top: 10px;
      border: 1px solid rgba(64, 150, 255, 0.2);
    }
    
    .alert-content strong {
      color: var(--primary);
    }
    
    .location-selector {
      margin-top: 10px;
    }
    
    select {
      width: 100%;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--primary);
      color: var(--light);
      border-radius: 8px;
      font-size: 0.85rem;
    }
    
    .error-message {
      color: #f5222d;
      font-size: 0.8rem;
      margin-top: 8px;
      padding: 8px;
      background: rgba(245, 34, 45, 0.1);
      border-radius: 6px;
      border: 1px solid rgba(245, 34, 45, 0.3);
    }
    
    .data-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .navigation {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .nav-item {
      text-align: center;
      padding: 12px;
      background: rgba(64, 150, 255, 0.2);
      border-radius: 8px;
      transition: all 0.3s ease;
      border: 1px solid rgba(64, 150, 255, 0.3);
    }
    
    .nav-item:hover {
      background: rgba(64, 150, 255, 0.4);
      transform: translateY(-2px);
    }
    
    .nav-icon {
      font-size: 1.2rem;
      margin-bottom: 5px;
    }
    
    .nav-text {
      color: white;
      font-size: 0.8rem;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    
    a {
      text-decoration: none;
      color: inherit;
    }
  </style>
</head>
<body>
  <header class="glass-effect">
    <div class="header-content">
      <h1>è‰¾æ¢ç´¢-ACEæ•°æ®</h1>
      <div class="current-time" id="current-time"></div>
    </div>
  </header>
  
  <div class="container">
    <!-- å¯¼èˆªåŒºåŸŸ -->
    <div class="navigation">
      <a href="index.html" class="nav-item">
        <div class="nav-icon text-aurora-blue">
          <i class="fa fa-home"></i>
        </div>
        <div class="nav-text">é¦–é¡µ</div>
      </a>
      <a href="forecast.html" class="nav-item">
        <div class="nav-icon text-aurora-green">
          <i class="fa fa-calendar"></i>
        </div>
        <div class="nav-text">ä¸‰å¤©é¢„æŠ¥</div>
      </a>
      <a href="27day.html" class="nav-item">
        <div class="nav-icon text-aurora-purple">
          <i class="fa fa-chart-line"></i>
        </div>
        <div class="nav-text">27å¤©é¢„æŠ¥</div>
      </a>
    </div>

    <!-- å¤ªé˜³é£ä¸æœ€æ–°æ•°æ®åˆå¹¶åŒºåŸŸ -->
    <div class="card alert-card">
      <div class="card-header">
        <div class="card-title">
          <span class="weather-icon">ğŸŒŒ</span>
          ç©ºé—´å¤©æ°”æ•°æ®
        </div>
        <div class="card-icon live-pulse">ğŸ”„</div>
      </div>
      
      <div class="data-grid">
        <div class="data-item">
          <span class="data-label">å¤ªé˜³é£é€Ÿ</span>
          <span class="data-value" id="speed">-- km/s</span>
        </div>
        <div class="data-item">
          <span class="data-label">ç²’å­å¯†åº¦</span>
          <span class="data-value" id="density">-- /cmÂ³</span>
        </div>
        <div class="data-item">
          <span class="data-label">Bzåˆ†é‡</span>
          <span class="data-value" id="bz">-- nT</span>
        </div>
        <div class="data-item">
          <span class="data-label">Btåˆ†é‡</span>
          <span class="data-value" id="bt">-- nT</span>
        </div>
        <div class="data-item">
          <span class="data-label">æ¸©åº¦</span>
          <span class="data-value" id="temperature">-- K</span>
        </div>
        <div class="data-item">
          <span class="data-label">HPIæŒ‡æ•° (åŒ—)</span>
          <span class="data-value" id="hpi-north">-- GW</span>
        </div>
        <div class="data-item">
          <span class="data-label">HPIæŒ‡æ•° (å—)</span>
          <span class="data-value" id="hpi-south">-- GW</span>
        </div>
      </div>
      
      <div class="alert-content" id="alert-content">
        æ•°æ®åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...
      </div>
      
      <div class="data-status">
        <span id="data-update-time">æœ€åæ›´æ–°: --</span>
        <span id="data-source-status">æ•°æ®æºçŠ¶æ€: åŠ è½½ä¸­...</span>
      </div>
      
      <div class="error-message" id="error-message"></div>
    </div>
    
    <div class="dashboard">      
      <!-- åˆ°è¾¾æ—¶é—´é¢„æµ‹å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="weather-icon">â±ï¸</span>
            å¤ªé˜³é£åˆ°è¾¾æ—¶é—´
          </div>
          <div class="card-icon">ğŸš€</div>
        </div>
        <div class="data-item">
          <span class="data-label">é€‰æ‹©è·ç¦»</span>
          <select id="location">
            <option value="1500000">åœ°çƒè½¨é“ (150ä¸‡km)</option>
            <option value="384400">æœˆçƒè·ç¦» (38.4ä¸‡km)</option>
            <option value="100000">è¿‘åœ°ç©ºé—´ (10ä¸‡km)</option>
          </select>
        </div>
        <div class="data-item" style="margin-top: 10px;">
          <span class="data-label">é¢„è®¡åˆ°è¾¾æ—¶é—´</span>
          <span class="data-value" id="arrival-time">--</span>
        </div>
        <div class="chart-container">
          <canvas id="arrivalChart"></canvas>
        </div>
      </div>
      
      <!-- HPIæŒ‡æ•°å›¾è¡¨å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="weather-icon">ğŸ“Š</span>
            HPIæŒ‡æ•° (åŒ—åŠçƒ)
          </div>
          <div class="card-icon">âš¡</div>
        </div>
        <div class="chart-container">
          <canvas id="hpiNorthChart"></canvas>
        </div>
      </div>
      
      <!-- HPIå—åŠçƒå›¾è¡¨å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="weather-icon">ğŸ“Š</span>
            HPIæŒ‡æ•° (å—åŠçƒ)
          </div>
          <div class="card-icon">âš¡</div>
        </div>
        <div class="chart-container">
          <canvas id="hpiSouthChart"></canvas>
        </div>
      </div>
      
      <!-- å¤ªé˜³é£é€Ÿåº¦å›¾è¡¨å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="weather-icon">ğŸ’¨</span>
            å¤ªé˜³é£é€Ÿåº¦ (2å°æ—¶æ•°æ®)
          </div>
          <div class="card-icon">ğŸŒªï¸</div>
        </div>
        <div class="chart-container">
          <canvas id="solarWindChart"></canvas>
        </div>
      </div>
      
      <!-- ç²’å­å¯†åº¦å›¾è¡¨å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="weather-icon">ğŸ”¬</span>
            ç²’å­å¯†åº¦ (2å°æ—¶æ•°æ®)
          </div>
          <div class="card-icon">ğŸ”</div>
        </div>
        <div class="chart-container">
          <canvas id="densityChart"></canvas>
        </div>
      </div>
      
      <!-- æ¸©åº¦å›¾è¡¨å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="weather-icon">ğŸŒ¡ï¸</span>
            å¤ªé˜³é£æ¸©åº¦ (2å°æ—¶æ•°æ®)
          </div>
          <div class="card-icon">ğŸ”¥</div>
        </div>
        <div class="chart-container">
          <canvas id="temperatureChart"></canvas>
        </div>
      </div>
      
      <!-- Bxåˆ†é‡å›¾è¡¨å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="weather-icon">ğŸ§²</span>
            Bxåˆ†é‡å˜åŒ– (2å°æ—¶æ•°æ®)
          </div>
          <div class="card-icon">ğŸ§­</div>
        </div>
        <div class="chart-container">
          <canvas id="bxChart"></canvas>
        </div>
      </div>
      
      <!-- Byåˆ†é‡å›¾è¡¨å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="weather-icon">ğŸ§²</span>
            Byåˆ†é‡å˜åŒ– (2å°æ—¶æ•°æ®)
          </div>
          <div class="card-icon">ğŸ§­</div>
        </div>
        <div class="chart-container">
          <canvas id="byChart"></canvas>
        </div>
      </div>
      
      <!-- Bzåˆ†é‡å›¾è¡¨å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="weather-icon">ğŸ§²</span>
            Bzåˆ†é‡å˜åŒ– (2å°æ—¶æ•°æ®)
          </div>
          <div class="card-icon">ğŸ§­</div>
        </div>
        <div class="chart-container">
          <canvas id="bzChart"></canvas>
        </div>
      </div>
      
      <!-- Btåˆ†é‡å›¾è¡¨å¡ç‰‡ -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <span class="weather-icon">ğŸ§²</span>
            Btåˆ†é‡å˜åŒ– (2å°æ—¶æ•°æ®)
          </div>
          <div class="card-icon">ğŸ§­</div>
        </div>
        <div class="chart-container">
          <canvas id="btChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å›¾è¡¨å®ä¾‹
    let solarWindChart, densityChart, temperatureChart, bxChart, byChart, bzChart, btChart;
    let hpiNorthChart, hpiSouthChart, arrivalChart;
    
    let currentData = {
      speed: 0,
      density: 0,
      temperature: 0,
      bx: 0,
      by: 0,
      bz: 0,
      bt: 0,
      hpiNorth: 0,
      hpiSouth: 0,
      stationCount: 0
    };
    
    let solarWindData = [];
    let arrivalData = [];
    let solarWindDelay = 0; // å¤ªé˜³é£ä¼ æ’­å»¶è¿Ÿï¼ˆåˆ†é’Ÿï¼‰
    const DSCOVR_DISTANCE = 1500000; // DSCOVRå«æ˜Ÿè·ç¦»åœ°çƒçº¦150ä¸‡å…¬é‡Œ
    const distanceSelect = document.getElementById('location');

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initCharts();
      updateClock();
      setInterval(updateClock, 1000);
      updateData();
      setInterval(updateData, 300000); // æ¯5åˆ†é’Ÿæ›´æ–°æ•°æ®
      
      // è·ç¦»é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°
      distanceSelect.addEventListener('change', updateArrivalChart);
    });

    // å¸¦è¶…æ—¶çš„fetchè¯·æ±‚
    function fetchWithTimeout(url, timeout = 5000) {
      return Promise.race([
        fetch(url),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), timeout)
        )
      ]);
    }

    // è§£æJSONå“åº”å¹¶å¤„ç†é”™è¯¯
    async function parseJSONResponse(response) {
      try {
        return await response.json();
      } catch (error) {
        throw new Error('JSONè§£æå¤±è´¥');
      }
    }

    // ã€ä¿®å¤åçš„HPIæ•°æ®è§£æå‡½æ•°ã€‘
    // å¤„ç†æ ¼å¼ä¸º"YYYY-MM-DD_HH:MM"çš„æ—¶é—´å­—æ®µ
    function parseHpiData(text) {
      const lines = text.split('\n');
      const data = [];
      let validDataCount = 0;
      
      console.log('HPIæ•°æ®è¡Œæ•°:', lines.length);
      
      for (const line of lines) {
        // è·³è¿‡æ³¨é‡Šè¡Œå’Œç©ºè¡Œ
        if (line.startsWith('#') || line.trim() === '') continue;
        
        const parts = line.trim().split(/\s+/);
        
        // ç¡®ä¿æœ‰è¶³å¤Ÿçš„å­—æ®µï¼ˆè§‚æµ‹æ—¶é—´ã€é¢„æŠ¥æ—¶é—´ã€åŒ—åŠçƒå€¼ã€å—åŠçƒå€¼ï¼‰
        if (parts.length >= 4) {
          try {
            // å¤„ç†è§‚æµ‹æ—¶é—´ï¼ˆæ ¼å¼ï¼šYYYY-MM-DD_HH:MMï¼‰
            const obsTimeStr = parts[0];
            // å°†ä¸‹åˆ’çº¿æ›¿æ¢ä¸ºTï¼Œè¡¥å…¨ç§’æ•°ï¼Œè½¬ä¸ºISOæ ¼å¼çš„UTCæ—¶é—´
            const isoTime = obsTimeStr.replace('_', 'T') + ':00Z';
            
            // éªŒè¯æ—¥æœŸæœ‰æ•ˆæ€§
            const dateObj = new Date(isoTime);
            if (isNaN(dateObj.getTime())) {
              console.warn('HPIæ—¥æœŸè§£æå¤±è´¥:', isoTime);
              continue;
            }
            
            // æå–å—åŒ—åŠçƒHPIæŒ‡æ•°
            const northVal = parseFloat(parts[2]);
            const southVal = parseFloat(parts[3]);
            
            // éªŒè¯æ•°æ®æœ‰æ•ˆæ€§
            if (isNaN(northVal) || isNaN(southVal)) {
              console.warn('HPIæ•°å€¼è§£æå¤±è´¥:', parts);
              continue;
            }
            
            data.push({
              dateTime: isoTime,
              north: northVal,
              south: southVal
            });
            
            validDataCount++;
            
          } catch (error) {
            console.warn('HPIæ•°æ®è¡Œè§£æå¼‚å¸¸:', line, error);
            continue;
          }
        } else {
          console.warn('HPIæ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œå­—æ®µä¸è¶³:', parts);
        }
      }
      
      console.log(`HPIæœ‰æ•ˆæ•°æ®ç‚¹: ${validDataCount}/${lines.length}`);
      return data;
    }

    // æ›´æ–°åˆ°è¾¾æ—¶é—´å›¾è¡¨
    function updateArrivalChart() {
      const distance = parseInt(distanceSelect.value);
      arrivalData = [];
      
      // è®¡ç®—ä¸åŒæ—¶é—´ç‚¹çš„åˆ°è¾¾æ—¶é—´
      solarWindData.forEach(item => {
        if (item.y > 0) {
          const timeMinutes = Math.round((distance / item.y) / 60);
          arrivalData.push({
            x: item.x,
            y: timeMinutes
          });
        }
      });
      
      // æ›´æ–°åˆ°è¾¾æ—¶é—´å›¾è¡¨
      arrivalChart.data.datasets[0].data = arrivalData;
      arrivalChart.update('none');
      
      // æ›´æ–°é¢„è®¡åˆ°è¾¾æ—¶é—´æ˜¾ç¤º
      if (solarWindData.length > 0 && currentData.speed > 0) {
        const timeMinutes = Math.round((distance / currentData.speed) / 60);
        const arrivalTime = new Date();
        arrivalTime.setMinutes(arrivalTime.getMinutes() + timeMinutes);
        
        document.getElementById('arrival-time').textContent = 
          `${timeMinutes} åˆ†é’Ÿå (${arrivalTime.toLocaleTimeString('zh-CN', {hour12: false})})`;
      } else {
        document.getElementById('arrival-time').textContent = '--';
      }
    }

    // è®¡ç®—æå…‰å¯è§æ€§
    function calculateAuroraVisibility() {
      let alertText = '';
      const alertCard = document.querySelector('.alert-card');
      
      // æ¸…é™¤ä¹‹å‰çš„è­¦æŠ¥ç±»
      alertCard.classList.remove('high-alert', 'extreme-alert');
      
      // æ ¹æ®HPIæŒ‡æ•°åˆ¤æ–­æå…‰æ´»åŠ¨å¼ºåº¦
      if (currentData.hpiNorth > 500 || currentData.hpiSouth > 500) {
        alertText = `<strong>å¼ºæå…‰æ´»åŠ¨!</strong> å—åŒ—åŠçƒå‡æ£€æµ‹åˆ°é«˜å¼ºåº¦æå…‰æ´»åŠ¨ï¼Œé«˜çº¬åº¦åœ°åŒºææ˜“è§‚æµ‹åˆ°æå…‰ã€‚`;
        alertCard.classList.add('extreme-alert');
      } else if (currentData.hpiNorth > 200 || currentData.hpiSouth > 200) {
        alertText = `<strong>ä¸­ç­‰æå…‰æ´»åŠ¨</strong> å—åŒ—åŠçƒå­˜åœ¨æ˜¾è‘—æå…‰æ´»åŠ¨ï¼Œé«˜çº¬åº¦åœ°åŒºæœ‰è¾ƒå¤§æœºä¼šè§‚æµ‹åˆ°æå…‰ã€‚`;
        alertCard.classList.add('high-alert');
      } else if (currentData.hpiNorth > 50 || currentData.hpiSouth > 50) {
        alertText = `<strong>å¼±æå…‰æ´»åŠ¨</strong> å—åŒ—åŠçƒå­˜åœ¨è¾ƒå¼±æå…‰æ´»åŠ¨ï¼Œä»…åœ¨é«˜çº¬åº¦åœ°åŒºå¯èƒ½è§‚æµ‹åˆ°ã€‚`;
      } else {
        alertText = `<strong>å¹³é™</strong> å½“å‰æå…‰æ´»åŠ¨è¾ƒå¼±ï¼Œè§‚æµ‹æœºä¼šè¾ƒä½ã€‚`;
      }
      
      // æ·»åŠ ç£åœºä¿¡æ¯
      if (currentData.bz < -10) {
        alertText += `<br>åœ°çƒç£åœºBzåˆ†é‡ä¸ºå¼ºå—å‘ï¼ˆ${currentData.bz} nTï¼‰ï¼Œæœ‰åˆ©äºæå…‰æ´»åŠ¨å¢å¼ºã€‚`;
      } else if (currentData.bz < 0) {
        alertText += `<br>åœ°çƒç£åœºBzåˆ†é‡ä¸ºå—å‘ï¼ˆ${currentData.bz} nTï¼‰ï¼Œå¯èƒ½å¢å¼ºæå…‰æ´»åŠ¨ã€‚`;
      }
      
      document.getElementById('alert-content').innerHTML = alertText;
    }

    // åˆå§‹åŒ–å›¾è¡¨
    function initCharts() {
      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              title: function(context) {
                // æ˜¾ç¤ºæœ¬åœ°æ—¶é—´ï¼ˆåŒ—äº¬æœ¬åœ°æ—¶é—´ï¼‰
                const date = new Date(context[0].parsed.x);
                return date.toLocaleString('zh-CN', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                  hour12: false
                });
              },
              label: function(context) {
                return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}`;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'hour',
              displayFormats: { hour: 'HH:mm' },
              tooltipFormat: 'MM-dd HH:mm'
            },
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { 
              color: 'rgba(255,255,255,0.7)', 
              maxRotation: 0, 
              font: { size: 10 },
              callback: function(value) {
                // æ˜¾ç¤ºåŒ—äº¬æœ¬åœ°æ—¶é—´
                const date = new Date(value);
                return date.toLocaleTimeString('zh-CN', {
                  hour: '2-digit',
                  minute: '2-digit',
                  hour12: false
                });
              }
            }
          },
          y: {
            grid: { color: 'rgba(255,255,255,0.05)' },
            ticks: { color: 'rgba(255,255,255,0.7)', font: { size: 10 } },
            beginAtZero: false
          }
        },
        elements: {
          point: { radius: 0 }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      };

      // å¤ªé˜³é£é€Ÿåº¦å›¾è¡¨
      const solarWindCtx = document.getElementById('solarWindChart').getContext('2d');
      solarWindChart = new Chart(solarWindCtx, {
        type: 'line',
        data: { datasets: [{
          label: 'å¤ªé˜³é£é€Ÿ (km/s)',
          data: [],
          borderColor: '#4096ff',
          backgroundColor: 'rgba(64, 150, 255, 0.1)',
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }] },
        options: chartOptions
      });

      // ç²’å­å¯†åº¦å›¾è¡¨
      const densityCtx = document.getElementById('densityChart').getContext('2d');
      densityChart = new Chart(densityCtx, {
        type: 'line',
        data: { datasets: [{
          label: 'ç²’å­å¯†åº¦ (/cmÂ³)',
          data: [],
          borderColor: '#52c41a',
          backgroundColor: 'rgba(82, 196, 26, 0.1)',
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }] },
        options: chartOptions
      });

      // æ¸©åº¦å›¾è¡¨
      const temperatureCtx = document.getElementById('temperatureChart').getContext('2d');
      temperatureChart = new Chart(temperatureCtx, {
        type: 'line',
        data: { datasets: [{
          label: 'æ¸©åº¦ (K)',
          data: [],
          borderColor: '#fa8c16',
          backgroundColor: 'rgba(250, 140, 22, 0.1)',
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }] },
        options: chartOptions
      });

      // Bxåˆ†é‡å›¾è¡¨
      const bxCtx = document.getElementById('bxChart').getContext('2d');
      bxChart = new Chart(bxCtx, {
        type: 'line',
        data: { datasets: [{
          label: 'Bxåˆ†é‡ (nT)',
          data: [],
          borderColor: '#f5222d',
          backgroundColor: 'rgba(245, 34, 45, 0.1)',
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }] },
        options: chartOptions
      });

      // Byåˆ†é‡å›¾è¡¨
      const byCtx = document.getElementById('byChart').getContext('2d');
      byChart = new Chart(byCtx, {
        type: 'line',
        data: { datasets: [{
          label: 'Byåˆ†é‡ (nT)',
          data: [],
          borderColor: '#722ed1',
          backgroundColor: 'rgba(114, 46, 209, 0.1)',
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }] },
        options: chartOptions
      });

      // Bzåˆ†é‡å›¾è¡¨
      const bzCtx = document.getElementById('bzChart').getContext('2d');
      bzChart = new Chart(bzCtx, {
        type: 'line',
        data: { datasets: [{
          label: 'Bzåˆ†é‡ (nT)',
          data: [],
          borderColor: '#ff4d4f',
          backgroundColor: 'rgba(255, 77, 79, 0.1)',
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }] },
        options: chartOptions
      });

      // Btåˆ†é‡å›¾è¡¨
      const btCtx = document.getElementById('btChart').getContext('2d');
      btChart = new Chart(btCtx, {
        type: 'line',
        data: { datasets: [{
          label: 'Btåˆ†é‡ (nT)',
          data: [],
          borderColor: '#6c5ce7',
          backgroundColor: 'rgba(108, 92, 231, 0.1)',
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }] },
        options: chartOptions
      });

      // HPIåŒ—åŠçƒå›¾è¡¨
      const hpiNorthCtx = document.getElementById('hpiNorthChart').getContext('2d');
      hpiNorthChart = new Chart(hpiNorthCtx, {
        type: 'line',
        data: { datasets: [{
          label: 'HPIåŒ—åŠçƒ (GW)',
          data: [],
          borderColor: '#a29bfe',
          backgroundColor: 'rgba(162, 155, 254, 0.1)',
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }] },
        options: chartOptions
      });

      // HPIå—åŠçƒå›¾è¡¨
      const hpiSouthCtx = document.getElementById('hpiSouthChart').getContext('2d');
      hpiSouthChart = new Chart(hpiSouthCtx, {
        type: 'line',
        data: { datasets: [{
          label: 'HPIå—åŠçƒ (GW)',
          data: [],
          borderColor: '#00b894',
          backgroundColor: 'rgba(0, 184, 148, 0.1)',
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }] },
        options: chartOptions
      });

      // åˆ°è¾¾æ—¶é—´å›¾è¡¨
      const arrivalCtx = document.getElementById('arrivalChart').getContext('2d');
      arrivalChart = new Chart(arrivalCtx, {
        type: 'line',
        data: { datasets: [{
          label: 'é¢„è®¡åˆ°è¾¾æ—¶é—´ (åˆ†é’Ÿ)',
          data: [],
          borderColor: '#00b894',
          backgroundColor: 'rgba(0, 184, 148, 0.1)',
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }] },
        options: chartOptions
      });

      // ä¿®å¤åçš„æ—¶é—´çº¿æ’ä»¶
      const solarWindDelayedTimeLinePlugin = {
        id: 'solarWindDelayedTimeLine',
        afterDraw: function(chart) {
          // åªåœ¨ç‰¹å®šå›¾è¡¨ä¸Šæ˜¾ç¤ºæ—¶é—´çº¿ï¼ˆæ’é™¤åˆ°è¾¾æ—¶é—´å›¾è¡¨ï¼‰
          if (chart.ctx.canvas.id === 'arrivalChart') {
            return; // åˆ°è¾¾æ—¶é—´å›¾è¡¨ä¸æ˜¾ç¤ºæ—¶é—´çº¿
          }
          
          const ctx = chart.ctx;
          const xAxis = chart.scales.x;
          const yAxis = chart.scales.y;
          
          // è·å–å½“å‰æ—¶é—´ï¼ˆåŒ—äº¬æœ¬åœ°æ—¶é—´ï¼‰
          const now = new Date();
          const nowTimestamp = now.getTime();
          
          // è®¡ç®—å¤ªé˜³é£å®é™…åˆ°è¾¾åœ°çƒçš„æ—¶é—´
          const arrivalTimestamp = nowTimestamp + solarWindDelay * 60 * 1000;
          
          // ç»˜åˆ¶å½“å‰æ—¶é—´çº¿
          const currentPosition = xAxis.getPixelForValue(nowTimestamp);
          if (currentPosition >= xAxis.left && currentPosition <= xAxis.right) {
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(currentPosition, yAxis.top);
            ctx.lineTo(currentPosition, yAxis.bottom);
            ctx.lineWidth = 1;
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.setLineDash([5, 3]);
            ctx.stroke();
            ctx.restore();
            
            // æ·»åŠ å½“å‰æ—¶é—´æ ‡ç­¾
            ctx.save();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.font = 'bold 10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.fillText('å½“å‰', currentPosition, yAxis.top - 18);
            ctx.restore();
          }

          // ç»˜åˆ¶é¢„è®¡åˆ°è¾¾æ—¶é—´çº¿ï¼ˆåªåœ¨å¤ªé˜³é£å»¶è¿Ÿ>0æ—¶æ˜¾ç¤ºï¼‰
          if (solarWindDelay > 0) {
            const arrivalPosition = xAxis.getPixelForValue(arrivalTimestamp);
            if (arrivalPosition >= xAxis.left && arrivalPosition <= xAxis.right) {
              ctx.save();
              ctx.beginPath();
              ctx.moveTo(arrivalPosition, yAxis.top);
              ctx.lineTo(arrivalPosition, yAxis.bottom);
              ctx.lineWidth = 2;
              ctx.strokeStyle = 'rgba(64, 150, 255, 0.9)';
              ctx.setLineDash([3, 3]);
              ctx.stroke();
              ctx.restore();
              
              // æ·»åŠ åˆ°è¾¾æ—¶é—´æ ‡ç­¾
              ctx.save();
              ctx.fillStyle = 'rgba(64, 150, 255, 1)';
              ctx.font = 'bold 10px Arial';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'bottom';
              ctx.fillText('é¢„è®¡åˆ°è¾¾', arrivalPosition, yAxis.bottom + 15);
              
              // æ·»åŠ å»¶è¿Ÿæ—¶é—´
              ctx.font = '9px Arial';
              ctx.fillText(`${solarWindDelay}åˆ†é’Ÿ`, arrivalPosition, yAxis.bottom + 28);
              ctx.restore();
            }
          }
        }
      };

      // ä¸ºæ‰€æœ‰å›¾è¡¨æ³¨å†Œæ’ä»¶
      Chart.register(solarWindDelayedTimeLinePlugin);
    }

    // æ›´æ–°æ—¶é—´ï¼ˆæ˜¾ç¤ºåŒ—äº¬æœ¬åœ°æ—¶é—´ï¼‰
    function updateClock() {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleString('zh-CN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      });
    }

    // å¢å¼ºçš„utcToBeijingDateå‡½æ•°
    function utcToBeijingDate(utcString) {
      try {
        let date;
        
        if (utcString.includes('T')) {
          // å·²ç»æ˜¯ISOæ ¼å¼
          date = new Date(utcString);
        } else {
          // å¤„ç†NOAAæ ¼å¼ "YYYY-MM-DD HH:MM:SS"
          const isoString = utcString.replace(' ', 'T') + 'Z';
          date = new Date(isoString);
        }
        
        // éªŒè¯æ—¥æœŸæœ‰æ•ˆæ€§
        if (isNaN(date.getTime())) {
          console.warn('æ—¥æœŸè§£æå¤±è´¥:', utcString);
          return new Date(); // è¿”å›å½“å‰æ—¶é—´ä½œä¸ºfallback
        }
        
        return date;
      } catch (error) {
        console.warn('æ—¥æœŸè½¬æ¢å¼‚å¸¸:', utcString, error);
        return new Date(); // è¿”å›å½“å‰æ—¶é—´ä½œä¸ºfallback
      }
    }

    // å¢å¼ºçš„æ•°æ®æ›´æ–°å‡½æ•°
    async function updateData() {
      try {
        // æ¸…é™¤é”™è¯¯ä¿¡æ¯
        document.getElementById('error-message').textContent = '';
        
        // è·å–æ•°æ®
        const [plasmaRes, magRes, hpiRes] = await Promise.all([
          fetchWithTimeout('https://services.swpc.noaa.gov/products/solar-wind/plasma-2-hour.json', 5000),
          fetchWithTimeout('https://services.swpc.noaa.gov/products/solar-wind/mag-2-hour.json', 5000),
          fetchWithTimeout('https://services.swpc.noaa.gov/text/aurora-nowcast-hemi-power.txt', 5000)
        ]);

        // æ£€æŸ¥å“åº”çŠ¶æ€
        if (!plasmaRes.ok || !magRes.ok || !hpiRes.ok) {
          throw new Error('éƒ¨åˆ†æ•°æ®æ¥å£å“åº”å¼‚å¸¸');
        }

        // è§£ææ•°æ®
        const plasmaData = await parseJSONResponse(plasmaRes);
        const magData = await parseJSONResponse(magRes);
        const hpiText = await hpiRes.text();

        // éªŒè¯æ•°æ®å®Œæ•´æ€§
        if (!Array.isArray(plasmaData) || plasmaData.length === 0 || 
            !Array.isArray(magData) || magData.length === 0) {
          throw new Error('å¤ªé˜³é£æ•°æ®æ ¼å¼å¼‚å¸¸');
        }

        // å¤„ç†å¤ªé˜³é£æ•°æ® - å®Œæ•´2å°æ—¶æ•°æ®
        const windData = plasmaData
          .filter(item => item && item.length >= 3 && !isNaN(parseFloat(item[2])))
          .map(item => ({
            x: utcToBeijingDate(item[0]),
            y: parseFloat(item[2])
          }));

        // è®¡ç®—å¤ªé˜³é£ä¼ æ’­å»¶è¿Ÿï¼ˆåŸºäºæœ€æ–°é£é€Ÿï¼‰
        if (windData.length > 0) {
          const latestSpeed = windData[windData.length - 1].y;
          if (latestSpeed > 0) {
            // è®¡ç®—ä»DSCOVRå«æ˜Ÿåˆ°åœ°çƒçš„ä¼ æ’­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
            solarWindDelay = Math.max(1, Math.round((DSCOVR_DISTANCE / latestSpeed) / 60));
          } else {
            solarWindDelay = 0;
          }
        } else {
          solarWindDelay = 0;
        }

        // å¤„ç†ç²’å­å¯†åº¦æ•°æ® - å®Œæ•´2å°æ—¶æ•°æ®
        const densityData = plasmaData
          .filter(item => item && item.length >= 2 && !isNaN(parseFloat(item[1])))
          .map(item => ({
            x: utcToBeijingDate(item[0]),
            y: parseFloat(item[1])
          }));

        // å¤„ç†æ¸©åº¦æ•°æ® - å®Œæ•´2å°æ—¶æ•°æ®
        const temperatureData = plasmaData
          .filter(item => item && item.length >= 4 && !isNaN(parseFloat(item[3])))
          .map(item => ({
            x: utcToBeijingDate(item[0]),
            y: parseFloat(item[3])
          }));

        // å¤„ç†ç£åœºåˆ†é‡æ•°æ® - å®Œæ•´2å°æ—¶æ•°æ®
        const bxData = magData
          .filter(item => item && item.length >= 2 && !isNaN(parseFloat(item[1])))
          .map(item => ({
            x: utcToBeijingDate(item[0]),
            y: parseFloat(item[1])
          }));

        const byData = magData
          .filter(item => item && item.length >= 3 && !isNaN(parseFloat(item[2])))
          .map(item => ({
            x: utcToBeijingDate(item[0]),
            y: parseFloat(item[2])
          }));

        const bzData = magData
          .filter(item => item && item.length >= 4 && !isNaN(parseFloat(item[3])))
          .map(item => ({
            x: utcToBeijingDate(item[0]),
            y: parseFloat(item[3])
          }));

        const btData = magData
          .filter(item => item && item.length >= 7 && !isNaN(parseFloat(item[6])))
          .map(item => ({
            x: utcToBeijingDate(item[0]),
            y: parseFloat(item[6])
          }));

        // å¤„ç†HPIæ•°æ® - å¢å¼ºé”™è¯¯å¤„ç†
        let hpiData = [];
        let hpiParseError = null;
        
        try {
          hpiData = parseHpiData(hpiText);
          if (hpiData.length === 0) {
            hpiParseError = 'HPIæ•°æ®è§£æç»“æœä¸ºç©º';
          }
        } catch (e) {
          hpiParseError = `HPIæ•°æ®è§£æå¼‚å¸¸: ${e.message}`;
          console.warn('HPIæ•°æ®è§£æå¼‚å¸¸:', e);
        }

        // æ›´æ–°å½“å‰æ•°æ® - å¢å¼ºHPIæ•°æ®å¤„ç†
        const latestWind = windData.length > 0 ? windData[windData.length - 1] : { y: 0 };
        const latestDensity = densityData.length > 0 ? densityData[densityData.length - 1] : { y: 0 };
        const latestTemperature = temperatureData.length > 0 ? temperatureData[temperatureData.length - 1] : { y: 0 };
        const latestBx = bxData.length > 0 ? bxData[bxData.length - 1] : { y: 0 };
        const latestBy = byData.length > 0 ? byData[byData.length - 1] : { y: 0 };
        const latestBz = bzData.length > 0 ? bzData[bzData.length - 1] : { y: 0 };
        const latestBt = btData.length > 0 ? btData[btData.length - 1] : { y: 0 };
        
        // HPIæ•°æ®å¤„ç†
        let latestHpi = { north: 0, south: 0 };
        if (hpiData.length > 0) {
          latestHpi = hpiData[hpiData.length - 1];
        } else if (hpiParseError) {
          console.warn(hpiParseError);
        }

        currentData = {
          speed: latestWind.y || 0,
          density: latestDensity.y || 0,
          temperature: latestTemperature.y || 0,
          bx: latestBx.y || 0,
          by: latestBy.y || 0,
          bz: latestBz.y || 0,
          bt: latestBt.y || 0,
          hpiNorth: latestHpi.north || 0,
          hpiSouth: latestHpi.south || 0
        };

        // æ›´æ–°ä¿¡æ¯é¢æ¿
        document.getElementById('speed').textContent = `${currentData.speed.toFixed(1)} km/s`;
        document.getElementById('density').textContent = `${currentData.density.toFixed(1)} /cmÂ³`;
        document.getElementById('temperature').textContent = `${currentData.temperature.toFixed(0)} K`;
        document.getElementById('bz').textContent = `${currentData.bz.toFixed(2)} nT`;
        document.getElementById('bt').textContent = `${currentData.bt.toFixed(2)} nT`;
        
        // HPIæ•°æ®æ˜¾ç¤º
        document.getElementById('hpi-north').textContent = 
          currentData.hpiNorth > 0 ? `${currentData.hpiNorth.toFixed(2)} GW` : '-- GW';
        document.getElementById('hpi-south').textContent = 
          currentData.hpiSouth > 0 ? `${currentData.hpiSouth.toFixed(2)} GW` : '-- GW';

        // æ›´æ–°æ•°æ®çŠ¶æ€ - æ·»åŠ HPIçŠ¶æ€ä¿¡æ¯
        let statusMessage = 'æ•°æ®æºçŠ¶æ€: æ­£å¸¸';
        if (hpiParseError) {
          statusMessage += ` | HPI: å¼‚å¸¸`;
        } else if (hpiData.length === 0) {
          statusMessage += ` | HPI: æ— æ•°æ®`;
        } else {
          statusMessage += ` | HPI: æ­£å¸¸`;
        }
        statusMessage += ` | å¤ªé˜³é£å»¶è¿Ÿ: ${solarWindDelay}åˆ†é’Ÿ`;
        
        document.getElementById('data-source-status').textContent = statusMessage;

        // æ›´æ–°æ‰€æœ‰å›¾è¡¨æ•°æ®
        solarWindChart.data.datasets[0].data = windData;
        solarWindChart.update('none');
        
        densityChart.data.datasets[0].data = densityData;
        densityChart.update('none');
        
        temperatureChart.data.datasets[0].data = temperatureData;
        temperatureChart.update('none');
        
        bxChart.data.datasets[0].data = bxData;
        bxChart.update('none');
        
        byChart.data.datasets[0].data = byData;
        byChart.update('none');
        
        bzChart.data.datasets[0].data = bzData;
        bzChart.update('none');
        
        btChart.data.datasets[0].data = btData;
        btChart.update('none');

        // æ›´æ–°HPIå›¾è¡¨ - å¢å¼ºé”™è¯¯å¤„ç†
        if (hpiData.length > 0) {
          try {
            hpiNorthChart.data.datasets[0].data = hpiData.map(item => ({
              x: utcToBeijingDate(item.dateTime),
              y: item.north
            }));
            hpiNorthChart.update('none');
            
            hpiSouthChart.data.datasets[0].data = hpiData.map(item => ({
              x: utcToBeijingDate(item.dateTime),
              y: item.south
            }));
            hpiSouthChart.update('none');
          } catch (chartError) {
            console.warn('HPIå›¾è¡¨æ›´æ–°å¤±è´¥:', chartError);
          }
        } else {
          // å¦‚æœæ²¡æœ‰HPIæ•°æ®ï¼Œæ¸…ç©ºå›¾è¡¨
          hpiNorthChart.data.datasets[0].data = [];
          hpiNorthChart.update('none');
          hpiSouthChart.data.datasets[0].data = [];
          hpiSouthChart.update('none');
        }

        // ä¿å­˜æ•°æ®ç”¨äºåˆ°è¾¾æ—¶é—´è®¡ç®—
        solarWindData = windData;
        updateArrivalChart();

        // è®¡ç®—æå…‰å¯è§æ€§
        calculateAuroraVisibility();

      } catch (error) {
        console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
        document.getElementById('error-message').textContent = 
          `æ•°æ®åŠ è½½å¤±è´¥: ${error.message} (æœ€åå°è¯•: ${new Date().toLocaleTimeString()})`;
        document.getElementById('alert-content').textContent = 'ä½¿ç”¨æœ€åæœ‰æ•ˆæ•°æ®';
        document.getElementById('data-source-status').textContent = 'æ•°æ®æºçŠ¶æ€: å¼‚å¸¸';
      }
    }
  </script>
</body>
</html>
